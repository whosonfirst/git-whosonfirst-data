#!/usr/bin/env python
# -*-python-*-

# Please to be reading this before you start making changes here:
# https://github.com/whosonfirst/git-whosonfirst-data#caveats

import os
import sys
import logging

import sys
import re
import subprocess

import mapzen.whosonfirst.utils
import mapzen.whosonfirst.git

logging.basicConfig(level=logging.INFO)

if __name__ == '__main__':

   import optparse
   opt_parser = optparse.OptionParser()

   opt_parser.add_option('--start-commit', dest='start_commit', action='store', default=None, help='The starting commit hash for determining changes (default is HEAD -2)')
   opt_parser.add_option('--stop-commit', dest='stop_commit', action='store', default=None, help='The ending commit hash for determining changes (default is HEAD -1)')

   opt_parser.add_option('-v', '--verbose', dest='verbose', action='store_true', default=False, help='Be chatty (default is false)')
   
   options, args = opt_parser.parse_args()

   if options.verbose:	
      logging.basicConfig(level=logging.DEBUG)
   else:
      logging.basicConfig(level=logging.INFO)

   # start of boilerplate-pydeps
   # ---------------------------

   import pkg_resources
   import requests
	
   # Some basic sanity checking to ensure that people are running the most recent
   # version of the py-mz-wof libraries (20160127/thisisaaronland)

   pymz = pkg_resources.get_distribution("mapzen.whosonfirst").version
   pymz = pymz.rstrip("-")

   current = None

   try:
      logging.info("I am going to try and see whether you are using the most recent version of py-mapzen-whosonfirst...")

      rsp = requests.get("https://raw.githubusercontent.com/whosonfirst/py-mapzen-whosonfirst/master/VERSION")
      current = rsp.content
      current = current.strip()

   except Exception, e:
      logging.warning("Failed to determine ACTUAL current version of py-mapzen-whosonfirst, because %s (setting current to %s for now but don't be surprised if HILARITY ensues...)" % (e, pymz))
      current = pymz

   if pymz != current:
      logging.warning("You are running version %s of py-mapzen-whosonfirst but the current version is %s - you should update because HILARITY may ensue if you don't" % (pymz, current))

   # -------------------------
   # end of boilerplate-pydeps
      
   # start of boilerplate-init
   # -------------------------

   # who's on first... har har har... sad trombone - remember that unlike
   # the other git hooks which are meant to be copied over to the wof-data
   # .git/hooks repository this one is stored somewhere and meant to be
   # invoked *from* the wof-data repository (20151113/thisisaaronland)

   root = os.getcwd()
   base = os.path.basename(root)

   if not base.startswith("whosonfirst-data"):
      logging.error("I don't think I am being invoked in the whosonfirst-data-* repository... RUNNING AWAY SCARED")
      sys.exit(1)

   # In case some one is running this straight out of the
   # .git/hooks folder

   whoami = os.path.abspath(sys.argv[0])

   if os.path.islink(whoami):
      whoami = os.path.realpath(whoami)

   if not options.config:

      hooks = os.path.dirname(whoami)
      path_config = os.path.join(hooks, 'hooks.cfg')

   else:
      path_config = os.path.abspath(options.config)

   if not os.path.exists(path_config):
      logging.error("INVISIBLE CONFIG FILE %s" % path_config)
      sys.exit(1)

   hooks = os.path.dirname(whoami)
   root = os.path.dirname(hooks)

   bin = os.path.join(root, "bin")
   lib = os.path.join(root, "lib")

   logging.info("append %s to path" % lib)
   sys.path.append(lib)

   whatami = sys.platform

   if whatami == 'darwin':
      bin = os.path.join(bin, "osx")
   elif whatami == 'win32':
      bin = os.path.join(bin, "windows")
   elif whatami == 'linux' or whatami == 'linux2':	# seriously... I have no idea what linux2 is...
      bin = os.path.join(bin, "linux")        
   else:
      logging.error("unknown or unsupported platform: %s" % whatami)
      sys.exit(1)

   # -----------------------
   # end of boilerplate-init

   # What do we have to work with...

   start_commit = options.start_commit
   stop_commit = options.stop_commit

   if not start_commit:
      start_commit = mapzen.whosonfirst.git.get_previous_hash()

   if not stop_commit:
      stop_commit = mapzen.whosonfirst.git.get_current_hash()

   logging.info("invoking git-whosonfirst-mapzen post-push hooks for %s - %s" % (start_commit, stop_commit))

   # start of boilerplate-getfiles
   # -----------------------------

   diff = mapzen.whosonfirst.git.get_diff(start_commit, stop_commit)
   logging.info("invoking hooks on %s possible files" % len(diff))

   files = []

   for fname in diff:

      parsed = mapzen.whosonfirst.utils.parse_filename(fname)

      if not parsed:
         continue

      id, suffix = parsed

      if suffix:
         logging.info("%s has a suffix (%s) so skipping" % (fname, suffix))
         continue
            
      files.append(fname)

   # -----------------------------
   # end of boilerplate-getfiles

   if len(files) == 0:
      logging.info("nothing in this commit that we need to apply pre-commit hooks to")
      sys.exit(0)

   import wof.validate

   if not wof.validate.validate_files(repo, files):
      logging.error("one or more files failed validation")
      sys.exit(1)

   #

   updated = []
   recommit = []

   for rel_path in files:

      abs_path = os.path.join(base, rel_path)
      logging.info("validating %s" % abs_path)

      updated.append(abs_path)
      recommit.append(rel_path)

   # these are used to extend 'modified' and 'created' below

   modified = []
   created = []

   import wof.meta
   import wof.concordances

   _modified, _created = wof.meta.update_metafiles(base, updated)

   for path in _modified:
      path = path.replace(base + "/", "")
      modified.append(path)

   for path in _created:
      path = path.replace(base + "/", "")
      created.append(path)

   _modified, _created = wof.concordances.update_concordances(base, updated)

   for path in _modified:
      path = path.replace(base + "/", "")
      modified.append(path)
      
   for path in _created:
      path = path.replace(base + "/", "")
      created.append(path)
      
   # phew!

   recommit.extend(modified)
   recommit.extend(created)

   # this is the part where we write the modified files to disk to be picked up by the
   # post-commit hook because trying to add them to the git index here results in one
   # face-stabby git error after another (take your pick) - if someone knows how to do
   # this (add/append the newly modified files to the current commit) at this stage I 
   # would love to hear about it. (20151112/thisisaaronland)

   # see also:
   # https://stackoverflow.com/questions/3284292/can-a-git-hook-automatically-add-files-to-the-commit

   if len(recommit):

      dotcommit = os.path.join(root, ".commit")
      logging.info("writing %s to disk to be processed by the post-commit hook" % dotcommit)

      fh = open(dotcommit, "w")
      fh.write("\n".join(recommit))
      fh.close()

   sys.exit(0)
